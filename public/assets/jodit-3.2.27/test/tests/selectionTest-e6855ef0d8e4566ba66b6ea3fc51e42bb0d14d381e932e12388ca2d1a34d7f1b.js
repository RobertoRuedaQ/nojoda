describe("Selection Module Tests",function(){describe("Current method",function(){describe("Cursor outside the editor",function(){it("Should return false",function(){var e=new Jodit(appendTestArea()),t=document.createElement("div");t.innerHTML="test",document.body.appendChild(t),e.value="<h1>test <span>test</span>sdfsdfds</h1>";var o=document.createRange();o.setStart(t.firstChild,1),o.setEnd(t.firstChild,2);var r=window.getSelection();r.removeAllRanges(),r.addRange(o),expect(e.selection.current()).to.be["false"],document.body.removeChild(t)})}),describe("Cursor in the left of some SPAN",function(){it("Should return text before this span",function(){var e=new Jodit(appendTestArea());e.value="<h1>one<span>two</span>tree</h1>";var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild,1),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.current()).to.be.equal(e.editor.firstChild.firstChild)})}),describe("Cursor inside the text node ",function(){it("Should return text",function(){var e=new Jodit(appendTestArea());e.value="<h1>test</h1>";var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,1),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.current()).to.be.equal(e.editor.firstChild.firstChild)})}),describe("Cursor after h1",function(){it("Should return text inside h1",function(){var e=new Jodit(appendTestArea());e.value="<h1>test</h1>";var t=e.editorDocument.createRange();t.setStart(e.editor,1),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.current()).to.be.equal(e.editor.firstChild.firstChild)}),describe("With false argument",function(){it("Should return h1",function(){var e=new Jodit(appendTestArea());e.value="<h1>test</h1>";var t=e.editorDocument.createRange();t.setStart(e.editor,1),t.collapse(!0),e.selection.selectRange(t),expect([e.editor.firstChild,e.editor.firstChild.firstChild]).to.be.include(e.selection.current(!1))})})}),describe("Select img",function(){it("Should return this image",function(){var e=new Jodit(appendTestArea());e.value='<h1>test <img src="#" alt=""> sdfsdfs</h1>';var t=e.editorDocument.createRange();t.selectNode(e.editor.querySelector("img")),e.selection.selectRange(t),expect(e.selection.current()).to.be.equal(e.editor.querySelector("img"))})})}),describe("cursorInTheEdge",function(){describe("Cursor in the text",function(){describe("Cursor in the end of text node but after this has BR",function(){it("Should return true",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test<br></p>");var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,4),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.be["true"]})}),describe("Cursor in the end of text node but after this has image",function(){it("Should return false",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test<img/></p>");var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,4),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.equal(!1)})}),describe("Cursor in the middle of text node",function(){it("Should return false",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test</p>");var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,2),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.equal(!1)}),describe("Cursor in the middle of text node but after cursor only invisible spaces",function(){it("Should return true",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test"+Jodit.INVISIBLE_SPACE+Jodit.INVISIBLE_SPACE+Jodit.INVISIBLE_SPACE+"</p>");var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,4),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.equal(!0)})}),describe("Cursor in the middle of text node but before cursor only invisible spaces",function(){it("Should return true",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>"+Jodit.INVISIBLE_SPACE+Jodit.INVISIBLE_SPACE+Jodit.INVISIBLE_SPACE+"test</p>");var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,3),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!0,e.editor.firstChild)).to.equal(!0)})}),describe("Cursor in the end of text node but after this has several not empty text nodes",function(){it("Should return false",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test</p>");var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,4),t.collapse(!0),e.selection.selectRange(t),e.selection.insertNode(e.editorDocument.createTextNode("a")),t.setStart(e.editor.firstChild.firstChild,4),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.be["false"]}),describe("Cursor in the end of text node and after are only text nodes with invisible spaces",function(){it("Should return true",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test</p>");var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,4),t.collapse(!0),e.selection.selectRange(t),e.selection.insertNode(e.editorDocument.createTextNode(Jodit.INVISIBLE_SPACE)),e.selection.insertNode(e.editorDocument.createTextNode(Jodit.INVISIBLE_SPACE)),e.selection.insertNode(e.editorDocument.createTextNode(Jodit.INVISIBLE_SPACE)),t.setStart(e.editor.firstChild.firstChild,4),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.equal(!0)})}),describe("Inverse",function(){describe("Cursor in the start of text node but before this has several not empty text nodes",function(){it("Should return false",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test</p>");var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,0),t.collapse(!0),e.selection.selectRange(t),e.selection.insertNode(e.editorDocument.createTextNode("a")),t.setStart(e.editor.firstChild.lastChild,0),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!0,e.editor.firstChild)).to.be["false"]}),describe("Cursor in the start of text node and before are only text nodes with invisible spaces",function(){it("Should return true",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test</p>");var t=e.editorDocument.createRange();t.setStart(e.editor.firstChild.firstChild,0),t.collapse(!0),e.selection.selectRange(t),e.selection.insertNode(e.editorDocument.createTextNode(Jodit.INVISIBLE_SPACE)),e.selection.insertNode(e.editorDocument.createTextNode(Jodit.INVISIBLE_SPACE)),e.selection.insertNode(e.editorDocument.createTextNode(Jodit.INVISIBLE_SPACE)),t.setStart(e.editor.firstChild.lastChild,0),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!0,e.editor.firstChild)).to.equal(!0)})})})})})})}),describe("Cursor after element",function(){it("Should return null",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test</p>");var t=e.editorDocument.createRange();t.setStartAfter(e.editor.firstChild),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.be.equal(null)})}),describe("Cursor before element",function(){it("Should return null",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test</p>");var t=e.editorDocument.createRange();t.setStartBefore(e.editor.firstChild),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!0,e.editor.firstChild)).to.be.equal(null)})}),describe("Cursor in the start of element ",function(){it("Should return true",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p><span>test</span></p>");var t=e.editorDocument.createRange();t.setStartBefore(e.editor.firstChild.firstChild),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!0,e.editor.firstChild)).to.be["true"]})}),describe("Cursor in the end of element ",function(){it("Should return true",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p><span>test</span></p>");var t=e.editorDocument.createRange();t.setStartAfter(e.editor.firstChild.firstChild),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.be["true"]})}),describe("Cursor not in the end of element ",function(){it("Should return false",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p><span>test</span><span>stop</span></p>");var t=e.editorDocument.createRange();t.setStartAfter(e.editor.firstChild.firstChild),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.be["false"]})}),describe("Cursor not in the start of element ",function(){it("Should return false",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p><span>test</span><span>stop</span></p>");var t=e.editorDocument.createRange();t.setStartAfter(e.editor.firstChild.firstChild),t.collapse(!0),e.selection.selectRange(t),expect(e.selection.cursorInTheEdge(!0,e.editor.firstChild)).to.be["false"]})}),describe("If cursor in the end of P",function(){it("Should return true",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test</p>>");var t=e.editorWindow.getSelection(),o=e.editorDocument.createRange();o.setStart(e.editor.firstChild.firstChild,4),o.collapse(!0),t.removeAllRanges(),t.addRange(o),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.equal(!0),o.setStart(e.editor.firstChild.firstChild,2),o.collapse(!0),t.removeAllRanges(),t.addRange(o),expect(e.selection.cursorInTheEdge(!1)).to.equal(!1)})}),describe("If cursor in the end of SPAN in the end of P",function(){it("Should return true",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>test<span>1</span></p>");var t=e.editorWindow.getSelection(),o=e.editorDocument.createRange();o.selectNodeContents(e.editor.firstChild.lastChild),o.collapse(!1),t.removeAllRanges(),t.addRange(o),expect(e.selection.cursorInTheEdge(!1,e.editor.firstChild)).to.equal(!0)})}),describe("Curson in the end of span inside P and check cursorInTheEdge(true)",function(){it("Should return false",function(){var e=new Jodit(appendTestArea());e.setEditorValue("<p>Some <span>text</span></p>");var t=e.editorWindow.getSelection(),o=e.editorDocument.createRange();o.selectNodeContents(e.editor.firstChild.lastChild),o.collapse(!1),t.removeAllRanges(),t.addRange(o),expect(e.selection.cursorInTheEdge(!0,e.editor.firstChild)).to.be["false"]})})}),describe("Change mode",function(){it("Should restore collapsed selection when user change mode - from WYSIWYG to TEXTAREA",function(){var e=new Jodit(appendTestArea(),{useAceEditor:!1});e.setEditorValue("<p>test</p>");var t=e.editorWindow.getSelection(),o=e.editorDocument.createRange();o.setStart(e.editor.firstChild.firstChild,2),o.collapse(!0),t.removeAllRanges(),t.addRange(o),e.setMode(Jodit.MODE_SOURCE);var r=e.container.querySelector("textarea.jodit_source_mirror");expect(r.value).to.equal("<p>test</p>"),expect(r.selectionStart).to.equal(5),expect(r.selectionEnd).to.equal(5)}),it("Should restore collapsed selection when user change mode - from WYSIWYG to TEXTAREA for long string",function(e){var t,o=function(){clearTimeout(t),e()};t=setTimeout(function(){expect(!1).to.equal(!0),o()},4e3);new Jodit(appendTestArea(),{defaultMode:Jodit.MODE_SOURCE,useAceEditor:!0,beautifyHTML:!1,events:{aceInited:function(e){e.setMode(Jodit.MODE_WYSIWYG),e.setEditorValue(("<p>"+"test ".repeat(50)+"</p>").repeat(1));var t=e.editorWindow.getSelection(),r=e.editorDocument.createRange();r.selectNodeContents(e.editor.querySelector("p")),r.collapse(!1),t.removeAllRanges(),t.addRange(r),e.selection.insertHTML("hello"),e.setMode(Jodit.MODE_SOURCE),expect(e.__plugins.source.aceEditor.getSelectionRange().start.column).to.equal(258),expect(e.__plugins.source.aceEditor.getSelectionRange().start.row).to.equal(0),e.__plugins.source.aceEditor.session.insert(e.__plugins.source.aceEditor.getCursorPosition()," world"),expect(e.__plugins.source.aceEditor.getValue()).to.equal("<p>"+"test ".repeat(49)+"test hello world</p>"),o()}}})}).timeout(6e3),it("Should restore collapsed selection when user change mode - from TEXTAREA to WYSIWYG",function(){var e=new Jodit(appendTestArea(),{useAceEditor:!1,defaultMode:Jodit.MODE_SOURCE});e.setEditorValue("<p>test</p>"),e.container.querySelector("textarea.jodit_source_mirror").setSelectionRange(5,5),e.setMode(Jodit.MODE_WYSIWYG),e.selection.insertNode(e.editorDocument.createTextNode(" a ")),expect(e.getEditorValue()).to.equal("<p>te a st</p>")}),it("Should restore non collapsed selection when user change mode - from WYSIWYG to TEXTAREA",function(){var e=new Jodit(appendTestArea(),{useAceEditor:!1});e.setEditorValue("<p>test</p>");var t=e.editorWindow.getSelection(),o=e.editorDocument.createRange();o.setStart(e.editor.firstChild.firstChild,1),o.setEnd(e.editor.firstChild.firstChild,3),t.removeAllRanges(),t.addRange(o),e.setMode(Jodit.MODE_SOURCE);var r=e.container.querySelector("textarea.jodit_source_mirror");expect(r.value).to.equal("<p>test</p>"),expect(r.selectionStart).to.equal(4),expect(r.selectionEnd).to.equal(6)}),describe("Problem",function(){it("Should restore non collapsed selection when user change mode - from TEXTAREA to WYSIWYG",function(){var e=new Jodit(appendTestArea(),{useAceEditor:!1,defaultMode:Jodit.MODE_SOURCE});e.selection.focus(),e.setEditorValue("<p>test</p>"),e.container.querySelector("textarea.jodit_source_mirror").setSelectionRange(2,8),e.setMode(Jodit.MODE_WYSIWYG),expect(e.selection.isCollapsed()).to.equal(!1),e.selection.insertNode(e.editorDocument.createTextNode(" a ")),expect(e.getEditorValue()).to.equal(" a ")})}),it("Should restore collapsed selection inside empty element - from TEXTAREA to WYSIWYG",function(){var e=new Jodit(appendTestArea(),{useAceEditor:!1,defaultMode:Jodit.MODE_SOURCE});e.setEditorValue("<a>11</a>"),e.container.querySelector("textarea.jodit_source_mirror").setSelectionRange(4,4),e.setMode(Jodit.MODE_WYSIWYG),expect(e.selection.isCollapsed()).to.equal(!0),e.selection.insertNode(e.editorDocument.createTextNode(" a ")),expect(e.getEditorValue()).to.equal("<a>1 a 1</a>")})}),describe("Click on empty tag",function(){it("Should move cursore inside that",function(){var e=new Jodit(appendTestArea());e.value="<p></p><p></p><p></p>",simulateEvent("mousedown",0,e.editor.getElementsByTagName("p")[1]),e.selection.insertHTML("test"),expect("<p></p><p>test</p><p></p>").to.be.equal(e.value)})}),describe("Method setCursorIn",function(){describe("Call for not Node element",function(){it("Should throw exception",function(){var e=new Jodit(appendTestArea());e.value="<p>1</p><p>2</p>",expect(function(){e.selection.setCursorIn(e.editor.querySelector("strong"))}).to["throw"]()})}),describe("Call for element what is not inside the current editor",function(){it("Should throw exception",function(){var e=new Jodit(appendTestArea());expect(function(){e.selection.setCursorIn(document.body)}).to["throw"]()})}),it("Should move cursor inside node in the end",function(){var e=new Jodit(appendTestArea());e.value="<p>1</p><p>2</p>",e.selection.setCursorIn(e.editor.lastChild),e.selection.insertHTML("test"),expect(e.value).to.be.equal("<p>1</p><p>2test</p>")}),describe("With inStart = true",function(){it("Should move cursor inside node in the start",function(){var e=new Jodit(appendTestArea());e.value="<p>1</p><p>2</p>",e.selection.setCursorIn(e.editor.lastChild,!0),e.selection.insertHTML("test"),expect(e.value).to.be.equal("<p>1</p><p>test2</p>")})})}),describe("Method eachSelection",function(){it("Should call callback for each node in selection",function(){var e=new Jodit(appendTestArea());e.value="<p>1</p><p>2</p><strong><span>22</span></strong><p>4</p>stop";var t=e.editorDocument.createRange();t.setStartBefore(e.editor.firstChild),t.setEndAfter(e.editor.lastChild),e.selection.selectRange(t);var o=[];e.selection.eachSelection(function(e){o.push(e.nodeName)}),expect(["P","P","STRONG","P","#text"].toString().toLowerCase()).to.be.equal(o.toString().toLowerCase())}),it("Should call callback for each node in selection range",function(){var e=new Jodit(appendTestArea());e.value="<p>1</p><p>2</p><strong><span>22</span></strong><p>4</p>stop";var t=e.editorDocument.createRange();t.setStartBefore(e.editor.firstChild.nextSibling),t.setEndAfter(e.editor.lastChild.previousSibling),e.selection.selectRange(t);var o=[];e.selection.eachSelection(function(e){o.push(e.nodeName)}),expect(["p","strong","p"].toString().toLowerCase()).to.be.equal(o.toString().toLowerCase())}),it("Should not call callback for editor",function(){var e=new Jodit(appendTestArea());e.value="",e.selection.setCursorIn(e.editor);var t=[];e.selection.eachSelection(function(e){t.push(e.nodeName)}),expect(["#text"].toString().toLowerCase()).to.be.equal(t.toString().toLowerCase())}),it("Should call callback for current node if selection is collapsed",function(){var e=new Jodit(appendTestArea());e.value="<p>1</p><p>2</p>",e.selection.setCursorIn(e.editor.firstChild);var t=[];e.selection.eachSelection(function(e){t.push(e.nodeName)}),expect(["#text"].toString().toLowerCase()).to.be.equal(t.toString().toLowerCase())}),describe("If selected element is UL or LI or content in LI",function(){})}),afterEach(removeStuff)});